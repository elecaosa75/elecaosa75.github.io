<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Misskey.io Client v19</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        body { 
            background-color: #000; 
            color: #e5e7eb; 
            overflow: hidden; 
            padding-bottom: env(safe-area-inset-bottom);
            /* Mobile Chromeの動的なアドレスバー対策 */
            height: 100dvh; 
            width: 100vw;
        }
        
        #root {
            height: 100%;
            width: 100%;
        }

        .custom-emoji {
            height: 1.3em;
            width: auto;
            display: inline-block;
            vertical-align: middle;
            margin: 0 1px;
        }
        
        .spinner {
            border: 2px solid rgba(255,255,255,0.1);
            border-left-color: currentColor;
            border-radius: 50%;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .mobile-safe-bottom {
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
        }

        .link-text {
            color: #60a5fa;
            text-decoration: none;
        }
        .link-text:hover {
            text-decoration: underline;
        }

        .filter-tab {
            padding: 8px 4px;
            font-size: 0.75rem;
            font-weight: bold;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            flex: 1;
            text-align: center;
            transition: all 0.2s;
        }
        .filter-tab.active {
            color: var(--theme-color, #4ade80);
            border-bottom-color: var(--theme-color, #4ade80);
            background-color: rgba(255,255,255,0.05);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, Component } = React;

        // --- Safe Error Logging ---
        const safeError = (msg, e) => {
            const errText = e ? (e.message || e.toString()) : "Unknown Error";
            try {
                if (typeof console !== 'undefined' && typeof console.error === 'function') {
                    console.error(msg, e);
                }
            } catch (err) {}
            return errText;
        };

        const translateError = (err) => {
            const msg = err.message || err.toString();
            if (msg.includes("Failed to fetch") || msg.includes("Load failed") || msg.includes("NetworkError")) {
                return "通信エラー: サーバーに接続できませんでした。";
            }
            return msg;
        };

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { safeError("ErrorBoundary", error); }
            render() {
                if (this.state.hasError) return <div className="flex flex-col items-center justify-center h-full text-center p-4 text-gray-400"><h2 className="text-xl font-bold text-red-500 mb-2">アプリエラー</h2><button onClick={()=>window.location.reload()} className="px-4 py-2 bg-gray-800 rounded text-white">再読み込み</button></div>;
                return this.props.children;
            }
        }

        const Icons = {
            Home: ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Globe: ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            Search: ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Settings: ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Repeat: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>,
            User: ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            X: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            Refresh: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>,
            Pin: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/></svg>,
            Send: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Image: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width={size} height={size} x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Reply: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 0 0-4-4H4"/></svg>,
            Heart: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
            ChevronLeft: ({size=32}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: ({size=32}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            Plus: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Trash: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Bookmark: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg>
        };

        const BASE_URL = "https://misskey.io/api";

        const fetchMisskey = async (endpoint, body, token) => {
            const headers = { "Content-Type": "application/json" };
            const payload = { ...body };
            if (token) payload.i = token;
            try {
                const res = await fetch(`${BASE_URL}/${endpoint}`, { method: "POST", headers, body: JSON.stringify(payload) });
                if (res.status === 204) return null;
                const text = await res.text();
                const json = text ? JSON.parse(text) : {};
                if (!res.ok) throw new Error(json.error?.message || `Error ${res.status}`);
                return json;
            } catch (e) { safeError("API Error", e); throw e; }
        };

        const parseNoteText = (text, emojis = []) => {
            if (!text) return null;
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const emojiMap = new Map(emojis.map(e => [e.name, e.url]));
            
            const parts = text.split(urlRegex);
            
            return parts.map((part, i) => {
                if (part.match(urlRegex)) {
                    return <a key={i} href={part} target="_blank" rel="noopener noreferrer" className="link-text" onClick={e=>e.stopPropagation()}>{part}</a>;
                }
                const subParts = part.split(/(:[a-zA-Z0-9_+-]+:)/g);
                return subParts.map((sub, j) => {
                    if (sub.startsWith(':') && sub.endsWith(':')) {
                        const name = sub.slice(1, -1);
                        const url = emojiMap.get(name);
                        if (url) return <img key={`${i}-${j}`} src={url} alt={name} className="custom-emoji" title={name} />;
                    }
                    return sub;
                });
            });
        };

        const LoadMoreButton = ({ onClick, isLoading, label="もっと読み込む" }) => (
            <button onClick={onClick} disabled={isLoading} className="w-full py-4 text-center text-gray-500 hover:text-white hover:bg-gray-900 transition border-t border-gray-800 flex justify-center items-center gap-2 mb-20 md:mb-0">
                {isLoading ? <div className="spinner w-4 h-4" /> : label}
            </button>
        );

        const ImageViewer = ({ images, initialIndex, onClose }) => {
            const [index, setIndex] = useState(initialIndex);
            useEffect(() => {
                const handleKey = (e) => {
                    if (e.key === 'Escape') onClose();
                    if (e.key === 'ArrowRight') setIndex(i => (i + 1) % images.length);
                    if (e.key === 'ArrowLeft') setIndex(i => (i - 1 + images.length) % images.length);
                };
                window.addEventListener('keydown', handleKey);
                return () => window.removeEventListener('keydown', handleKey);
            }, [images, onClose]);
            const current = images[index];
            return (
                <div className="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center animate-fade-in" onClick={onClose}>
                    <button onClick={onClose} className="absolute top-8 right-4 text-gray-400 hover:text-white z-50 p-2 bg-black/50 rounded-full"><Icons.X size={32}/></button>
                    {images.length > 1 && <button onClick={(e) => { e.stopPropagation(); setIndex((index - 1 + images.length) % images.length); }} className="absolute left-2 text-gray-400 hover:text-white p-2"><Icons.ChevronLeft /></button>}
                    <div className="max-w-full max-h-full p-2 flex flex-col items-center" onClick={e => e.stopPropagation()}>
                        {current.type.startsWith('image') ? <img src={current.url} className="max-w-full max-h-[80vh] object-contain" /> : <div className="text-white">Media</div>}
                        {images.length > 1 && <div className="mt-4 text-gray-500 font-mono text-sm">{index + 1} / {images.length}</div>}
                    </div>
                    {images.length > 1 && <button onClick={(e) => { e.stopPropagation(); setIndex((index + 1) % images.length); }} className="absolute right-2 text-gray-400 hover:text-white p-2"><Icons.ChevronRight /></button>}
                </div>
            );
        };

        const Note = ({ note, onClickUser, onAction, onViewImage, themeColor, myUser }) => {
            const displayNote = note.renote ? note.renote : note;
            const isRenote = !!note.renote;
            const user = displayNote.user;
            const [hasReacted, setHasReacted] = useState(!!displayNote.myReaction);
            const [reactionCount, setReactionCount] = useState((displayNote.reactions && displayNote.reactions['❤️']) || 0);
            const [isFavorited, setIsFavorited] = useState(!!displayNote.isFavorited);
            const isMyNote = myUser && user.id === myUser.id;

            useEffect(() => {
                setHasReacted(!!displayNote.myReaction);
                setReactionCount((displayNote.reactions && displayNote.reactions['❤️']) || 0);
                setIsFavorited(!!displayNote.isFavorited);
            }, [displayNote.myReaction, displayNote.reactions, displayNote.isFavorited]);

            const handleHeart = (e) => {
                e.stopPropagation();
                if (!hasReacted) {
                    setHasReacted(true);
                    setReactionCount(c => c + 1);
                    onAction('heart', displayNote);
                }
            };

            const handleBookmark = (e) => {
                e.stopPropagation();
                // Optimistic update
                const newValue = !isFavorited;
                setIsFavorited(newValue);
                onAction('bookmark', displayNote, newValue); // Pass new state
            };

            if (!user) return null;

            return (
                <div className="p-3 border-b border-gray-800 hover:bg-gray-900/40 transition-colors animate-fade-in text-sm md:text-base group relative">
                    {isRenote && <div className="text-xs text-green-400 mb-1 flex items-center gap-1" style={{ color: themeColor }}><Icons.Repeat size={12}/><span>Renoted by {note.user.name}</span></div>}
                    <div className="flex gap-3">
                        <img src={user.avatarUrl} className="w-10 h-10 rounded-full object-cover flex-shrink-0" onClick={e => {e.stopPropagation(); onClickUser(user)}} />
                        <div className="flex-1 min-w-0">
                            <div className="flex justify-between items-start">
                                <div className="truncate pr-2" onClick={() => onClickUser(user)}>
                                    <span className="font-bold mr-1 text-gray-200">{user.name || user.username}</span>
                                    <span className="text-gray-500 text-xs">@{user.username}</span>
                                </div>
                                <span className="text-gray-600 text-xs flex-shrink-0">{new Date(displayNote.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            </div>
                            <div className="mt-1 text-gray-300 whitespace-pre-wrap break-words leading-relaxed">{parseNoteText(displayNote.text, displayNote.emojis)}</div>
                            {displayNote.files?.length > 0 && (
                                <div className={`mt-2 grid gap-1.5 ${displayNote.files.length > 1 ? 'grid-cols-2' : 'grid-cols-1 max-w-[280px]'}`}>
                                    {displayNote.files.map((f, i) => (
                                        <div key={f.id} className="relative aspect-video bg-gray-800 rounded overflow-hidden border border-gray-700" onClick={e => { e.stopPropagation(); onViewImage(displayNote.files, i); }}>
                                            {f.type.startsWith('image') ? <img src={f.thumbnailUrl || f.url} className="w-full h-full object-cover" /> : <div className="flex items-center justify-center h-full text-xs text-gray-500">Media</div>}
                                        </div>
                                    ))}
                                </div>
                            )}
                            <div className="flex items-center justify-between mt-3 text-gray-500 w-full max-w-[240px]">
                                <button onClick={e => {e.stopPropagation(); onAction('reply', displayNote)}} className="hover:text-blue-400 p-1"><Icons.Reply /></button>
                                <button onClick={e => {e.stopPropagation(); onAction('renote', displayNote)}} className="hover:text-green-400 p-1"><Icons.Repeat />{displayNote.renoteCount > 0 && <span className="text-xs ml-1">{displayNote.renoteCount}</span>}</button>
                                <button onClick={handleHeart} className={`${hasReacted ? 'text-pink-500' : 'hover:text-pink-500'} p-1`}><Icons.Heart fill={hasReacted ? "currentColor" : "none"} />{reactionCount > 0 && <span className="text-xs ml-1">{reactionCount}</span>}</button>
                                <button onClick={handleBookmark} className={`${isFavorited ? 'text-orange-400' : 'hover:text-orange-400'} p-1`}><Icons.Bookmark fill={isFavorited ? "currentColor" : "none"} /></button>
                                {isMyNote && (
                                    <button onClick={e => { e.stopPropagation(); onAction('delete', note); }} className="hover:text-red-500 text-gray-600 p-3 -m-2 relative z-10" title="削除 (確認なし)"><Icons.Trash /></button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PostForm = ({ token, themeColor, replyTo, onCancelReply, onSuccess, onClose, isMobile }) => {
            const [text, setText] = useState("");
            const [files, setFiles] = useState([]);
            const [isNsfw, setIsNsfw] = useState(false);
            const [isSending, setIsSending] = useState(false);
            const fileInputRef = useRef(null);

            const handleFileSelect = (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    const newFiles = Array.from(e.target.files);
                    setFiles(prev => [...prev, ...newFiles].slice(0, 4));
                }
                if (fileInputRef.current) fileInputRef.current.value = "";
            };

            const handleSubmit = async () => {
                if (!text.trim() && files.length === 0) return;
                if (!token) return alert("トークンが必要です");
                setIsSending(true);
                try {
                    const uploadedIds = [];
                    for (const file of files) {
                        const fd = new FormData();
                        fd.append("file", file);
                        fd.append("i", token);
                        fd.append("isSensitive", String(isNsfw));
                        const res = await fetch(`${BASE_URL}/drive/files/create`, { method: "POST", body: fd });
                        const json = await res.json();
                        if (json.id) uploadedIds.push(json.id);
                    }
                    const params = { visibility: 'public' };
                    if (text.trim()) params.text = text;
                    if (uploadedIds.length) params.fileIds = uploadedIds;
                    if (replyTo) params.replyId = replyTo.id;
                    if (!params.text && !params.fileIds) params.text = ".";

                    await fetchMisskey("notes/create", params, token);
                    setText(""); setFiles([]); setIsNsfw(false);
                    if (onCancelReply) onCancelReply();
                    if (onSuccess) onSuccess();
                    if (onClose) onClose(); 
                } catch (e) { alert(translateError(e)); } 
                finally { setIsSending(false); }
            };

            return (
                <div className={`flex flex-col bg-gray-900 p-3 ${isMobile ? 'h-full' : 'h-full border-t border-gray-700'}`}>
                    {isMobile && <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-white">New Post</h3><button onClick={onClose}><Icons.X /></button></div>}
                    {replyTo && <div className="flex justify-between items-center bg-gray-800 border-l-4 border-blue-500 px-3 py-2 rounded mb-2 text-xs"><span className="text-gray-300 truncate flex-1">To: @{replyTo.user.username}</span><button onClick={onCancelReply}><Icons.X size={14}/></button></div>}
                    <textarea className="flex-1 bg-gray-800 border border-gray-700 rounded p-3 text-base text-white resize-none focus:outline-none focus:border-opacity-50 placeholder-gray-600" placeholder={replyTo ? "返信..." : "いまどうしてる？"} style={{ borderColor: themeColor }} value={text} onChange={e => setText(e.target.value)}/>
                    {files.length > 0 && <div className="flex gap-2 mt-2 overflow-x-auto py-2">{files.map((f, i) => <div key={i} className="relative flex-shrink-0 w-16 h-16 rounded border border-gray-700 overflow-hidden"><img src={URL.createObjectURL(f)} className="w-full h-full object-cover"/><button onClick={() => setFiles(prev => prev.filter((_, idx) => idx !== i))} className="absolute top-0 right-0 bg-black/80 text-white p-0.5"><Icons.X size={12}/></button></div>)}</div>}
                    <div className="mt-3 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <button onClick={() => fileInputRef.current?.click()} className="flex items-center gap-2 bg-gray-800 text-gray-300 px-3 py-2 rounded text-xs border border-gray-600" disabled={files.length >= 4}><Icons.Image size={18}/> <span className={isMobile ? "inline" : "hidden xl:inline"}>画像</span></button>
                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" multiple onChange={handleFileSelect} />
                            <label className="flex items-center gap-1 text-xs text-gray-500"><input type="checkbox" checked={isNsfw} onChange={e => setIsNsfw(e.target.checked)} className="rounded bg-gray-800 border-gray-600 accent-pink-500"/> NSFW</label>
                        </div>
                        <button onClick={handleSubmit} disabled={isSending || (!text.trim() && !files.length)} className="px-5 py-2 rounded text-sm font-bold text-black transition opacity-90 hover:opacity-100" style={{ backgroundColor: themeColor }}>{isSending ? '...' : <Icons.Send size={18} />}</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [token, setToken] = useState(localStorage.getItem("misskey_token") || "");
            const [themeColor, setThemeColor] = useState(localStorage.getItem("misskey_color") || "#4ade80");
            const [myUser, setMyUser] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [showMobilePost, setShowMobilePost] = useState(false);
            
            const [activeTab, setActiveTab] = useState("timeline");
            const [replyTarget, setReplyTarget] = useState(null);
            const [viewerState, setViewerState] = useState(null);

            // TL
            const [tlType, setTlType] = useState("local");
            const [leftNotes, setLeftNotes] = useState([]);
            const [leftUntilId, setLeftUntilId] = useState(null);
            const [isLoadingLeft, setIsLoadingLeft] = useState(false);

            // User
            const [selectedUser, setSelectedUser] = useState(null);
            const [userNotes, setUserNotes] = useState([]);
            const [userUntilId, setUserUntilId] = useState(null);
            const [followers, setFollowers] = useState([]);
            const [userFilter, setUserFilter] = useState("all");
            const [userSearchQuery, setUserSearchQuery] = useState(""); 
            const [isLoadingUser, setIsLoadingUser] = useState(false);

            // Search / Bookmark (PC Right Bottom)
            const [searchQuery, setSearchQuery] = useState("");
            const [searchResults, setSearchResults] = useState([]);
            const [searchUntilId, setSearchUntilId] = useState(null);
            const [searchFilter, setSearchFilter] = useState("all"); // 'all', 'media', 'bookmarks'
            const [isLoadingSearch, setIsLoadingSearch] = useState(false);
            // Bookmark List State
            const [bookmarkNotes, setBookmarkNotes] = useState([]);
            const [bookmarkUntilId, setBookmarkUntilId] = useState(null);
            const [isLoadingBookmarks, setIsLoadingBookmarks] = useState(false);

            useEffect(() => { if(token) fetchMisskey("i", {}, token).then(d => {if(d && !d.error) setMyUser(d)}); }, [token]);

            const handleAction = (type, note, extra) => {
                if (!token) return alert("トークンが必要です");
                if (type === 'reply') {
                    setReplyTarget(note);
                    if (window.innerWidth < 768) setShowMobilePost(true); 
                } else if (type === 'renote') {
                    if(confirm("リノートしますか？")) fetchMisskey("notes/create", {renoteId: note.id}, token).then(()=>alert("完了")).catch(e=>alert(translateError(e)));
                } else if (type === 'heart') {
                    fetchMisskey("notes/reactions/create", {noteId: note.id, reactionId: '❤️'}, token).catch(()=>{}); 
                } else if (type === 'bookmark') {
                    // extra is boolean (isFavorited)
                    const ep = extra ? "notes/favorites/create" : "notes/favorites/delete";
                    fetchMisskey(ep, {noteId: note.id}, token).catch(()=>{});
                } else if (type === 'delete') {
                    fetchMisskey("notes/delete", {noteId: note.id}, token)
                        .then(() => {
                            setLeftNotes(prev => prev.filter(n => n.id !== note.id));
                            setUserNotes(prev => prev.filter(n => n.id !== note.id));
                        })
                        .catch(e => alert("削除失敗: " + translateError(e)));
                }
            };

            // -- Data Loaders --
            const loadTimeline = async (mode="reload") => {
                if (isLoadingLeft) return;
                setIsLoadingLeft(true);
                const ep = tlType === "home" ? "notes/timeline" : "notes/local-timeline";
                const body = { limit: 20, untilId: mode === "more" ? leftUntilId : undefined };
                try {
                    const d = await fetchMisskey(ep, body, token);
                    if (Array.isArray(d)) {
                        setLeftNotes(p => mode==="reload" ? d : [...p, ...d]);
                        if(d.length) setLeftUntilId(d[d.length-1].id);
                    }
                } catch(e){ if(mode === "reload") alert(translateError(e)); } finally { setIsLoadingLeft(false); }
            };
            useEffect(() => { loadTimeline("reload"); }, [tlType, token]);

            const loadUserContent = async (mode="reload") => {
                if (isLoadingUser) return;
                setIsLoadingUser(true);
                try {
                    if(selectedUser) {
                        if (userSearchQuery) {
                            const body = { query: userSearchQuery, userId: selectedUser.id, limit: 30, untilId: mode==="more" ? userUntilId : undefined };
                            const d = await fetchMisskey("notes/search", body, token);
                            if(Array.isArray(d)) {
                                let filtered = d;
                                if (userFilter === 'media') filtered = filtered.filter(n => n.files && n.files.length > 0);
                                setUserNotes(p => mode==="reload" ? filtered : [...p, ...filtered]);
                                if(d.length) setUserUntilId(d[d.length-1].id);
                            }
                        } else {
                            const body = { userId: selectedUser.id, limit: 20, untilId: mode==="more" ? userUntilId : undefined, includeMyRenotes: userFilter === 'all', includeReplies: false, withFiles: userFilter === 'media' };
                            const d = await fetchMisskey("users/notes", body, token);
                            if(Array.isArray(d)) {
                                setUserNotes(p => mode==="reload" ? d : [...p, ...d]);
                                if(d.length) setUserUntilId(d[d.length-1].id);
                            }
                        }
                    } else if (myUser) {
                        const body = { userId: myUser.id, limit: 50 };
                        const d = await fetchMisskey("users/following", body, token);
                        if(Array.isArray(d)) setFollowers(d.map(f => f.followee));
                    }
                } catch (e) { if(mode === "reload") alert(translateError(e)); } finally { setIsLoadingUser(false); }
            };
            useEffect(() => { loadUserContent("reload"); }, [selectedUser, myUser, userFilter]); 

            const executeUserSearch = (e) => {
                e.preventDefault();
                setIsLoadingUser(false); setUserUntilId(null); loadUserContent("reload");
            };

            // -- Search / Bookmarks --
            const executeSearch = async (mode="reload") => {
                if (isLoadingSearch) return;
                if (!searchQuery) return alert("キーワードを入力してください");
                setIsLoadingSearch(true);
                if (mode === "reload") setSearchResults([]);
                try {
                    const body = { query: searchQuery, limit: 30, untilId: mode === "more" ? searchUntilId : undefined };
                    const notes = await fetchMisskey("notes/search", body, token);
                    if (Array.isArray(notes)) {
                        let filtered = notes;
                        if (searchFilter === 'media') filtered = filtered.filter(n => n.files && n.files.length > 0);
                        if (mode === "reload") setSearchResults(filtered);
                        else setSearchResults(prev => [...prev, ...filtered]);
                        if (notes.length > 0) setSearchUntilId(notes[notes.length-1].id);
                    } else if (mode === "reload") setSearchResults([]);
                } catch(e) { alert("検索エラー: " + translateError(e)); } finally { setIsLoadingSearch(false); }
            };

            const loadBookmarks = async (mode="reload") => {
                if (isLoadingBookmarks) return;
                setIsLoadingBookmarks(true);
                try {
                    const body = { limit: 20, untilId: mode === "more" ? bookmarkUntilId : undefined };
                    const d = await fetchMisskey("i/favorites", body, token);
                    if (Array.isArray(d)) {
                        const notes = d.map(f => ({...f.note, isFavorited: true})); // Mark as favorited
                        if (mode === "reload") setBookmarkNotes(notes);
                        else setBookmarkNotes(p => [...p, ...notes]);
                        if(d.length > 0) setBookmarkUntilId(d[d.length-1].id);
                    }
                } catch(e) { if(mode==="reload") alert(translateError(e)); } finally { setIsLoadingBookmarks(false); }
            };

            // Effect for Search/Bookmark Tab Switch
            useEffect(() => {
                if (searchFilter === 'bookmarks') {
                    loadBookmarks("reload");
                } else if (searchQuery) {
                    // Re-run search if filtered
                    setSearchUntilId(null); setIsLoadingSearch(false); executeSearch("reload");
                }
            }, [searchFilter]);

            // Effect for Mobile Tab Switch (Refresh Bookmark when tab active)
            useEffect(() => {
                if (activeTab === 'bookmark') {
                    loadBookmarks("reload");
                }
            }, [activeTab]);


            return (
                <ErrorBoundary>
                    <div className="flex flex-col md:flex-row h-full w-full bg-black text-gray-200 font-sans overflow-hidden" style={{'--theme-color': themeColor}}>
                        {viewerState && <ImageViewer images={viewerState.images} initialIndex={viewerState.index} onClose={() => setViewerState(null)} />}
                        
                        {/* TL */}
                        <div className={`flex-col h-full bg-gray-950 border-r border-gray-800 ${activeTab === 'timeline' ? 'flex w-full' : 'hidden'} md:flex md:w-1/2`}>
                            <div className="flex border-b border-gray-800 bg-gray-900/80 h-12 flex-shrink-0">
                                {['home', 'local'].map(t => <button key={t} onClick={() => setTlType(t)} className={`flex-1 font-bold uppercase text-sm flex items-center justify-center gap-2 ${tlType === t ? 'bg-white/5' : 'text-gray-500'}`} style={tlType === t ? {color:themeColor, borderBottom:`2px solid ${themeColor}`} : {}}>{t}</button>)}
                                <button onClick={() => loadTimeline("reload")} className="px-4 hover:text-white text-gray-500"><Icons.Refresh /></button>
                                <button onClick={() => setShowSettings(true)} className="px-4 hover:text-white text-gray-500 md:block hidden"><Icons.Settings /></button>
                            </div>
                            <div className="flex-1 overflow-y-auto mobile-safe-bottom">
                                {leftNotes.map(n => <Note key={n.id} note={n} onClickUser={u => {setSelectedUser(u); setActiveTab('user');}} onAction={handleAction} onViewImage={(imgs, i) => setViewerState({images: imgs, index: i})} themeColor={themeColor} myUser={myUser} />)}
                                <LoadMoreButton onClick={() => loadTimeline("more")} isLoading={isLoadingLeft} />
                            </div>
                            <div className="hidden md:block h-1/4 min-h-[180px] flex-shrink-0"><PostForm token={token} themeColor={themeColor} replyTo={replyTarget} onCancelReply={() => setReplyTarget(null)} onSuccess={() => {setReplyTarget(null); loadTimeline("reload");}} /></div>
                        </div>

                        {/* Right Panel */}
                        <div className={`flex-col h-full ${activeTab !== 'timeline' ? 'flex w-full' : 'hidden'} md:flex md:w-1/2`}>
                            
                            {/* User */}
                            <div className={`flex-col bg-gray-900/20 border-b border-gray-800 ${activeTab === 'user' ? 'flex h-full' : 'hidden'} md:flex md:h-1/2`}>
                                <div className="h-auto min-h-[3rem] border-b border-gray-800 bg-gray-900 flex flex-col flex-shrink-0">
                                    <div className="flex items-center justify-between px-4 py-2">
                                        <div className="font-bold text-sm truncate" style={{color: themeColor}}>{selectedUser ? selectedUser.name : "FOLLOWING"}</div>
                                        <div className="flex gap-2">
                                            {selectedUser && <button onClick={() => setSelectedUser(null)} className="text-xs border border-gray-600 px-2 py-1 rounded">Close</button>}
                                            <button onClick={() => loadUserContent("reload")}><Icons.Refresh size={18}/></button>
                                        </div>
                                    </div>
                                    {selectedUser && (
                                        <div className="px-2 pb-2">
                                            <form onSubmit={executeUserSearch} className="flex gap-2 mb-2 px-2">
                                                <input type="text" placeholder="このユーザーの投稿を検索..." className="flex-1 bg-gray-800 border border-gray-700 rounded px-2 py-1 text-xs text-white outline-none focus:border-gray-500" value={userSearchQuery} onChange={e => setUserSearchQuery(e.target.value)} />
                                                <button type="submit" className="bg-gray-700 text-white px-3 rounded flex items-center justify-center hover:bg-gray-600 transition" disabled={isLoadingUser}>{isLoadingUser ? <div className="spinner w-3 h-3 border-2" /> : <Icons.Search size={14}/>}</button>
                                            </form>
                                            <div className="flex px-2">{['all', 'notes', 'media'].map(f => <button key={f} onClick={() => setUserFilter(f)} className={`filter-tab ${userFilter === f ? 'active' : ''}`}>{f.toUpperCase()}</button>)}</div>
                                        </div>
                                    )}
                                </div>
                                <div className="flex-1 overflow-y-auto mobile-safe-bottom">
                                    {selectedUser ? userNotes.map(n => <Note key={n.id} note={n} onClickUser={()=>{}} onAction={handleAction} onViewImage={(imgs, i) => setViewerState({images: imgs, index: i})} themeColor={themeColor} myUser={myUser}/>) : 
                                    followers.map(u => <div key={u.id} onClick={() => setSelectedUser(u)} className="flex items-center gap-3 p-3 border-b border-gray-800 hover:bg-gray-800 cursor-pointer"><img src={u.avatarUrl} className="w-8 h-8 rounded-full"/><div className="text-sm font-bold text-gray-300">{u.name}</div></div>)}
                                    {selectedUser && <LoadMoreButton onClick={() => loadUserContent("more")} isLoading={isLoadingUser} />}
                                </div>
                            </div>

                            {/* Search / Bookmark (PC Bottom Right / Mobile Tab) */}
                            <div className={`flex-col bg-gray-950 border-t border-gray-800 ${activeTab === 'search' || activeTab === 'bookmark' ? 'flex h-full' : 'hidden'} md:flex md:h-1/2`}>
                                {/* Header Area (Search Form or Bookmark Title) */}
                                <div className="p-3 border-b border-gray-800 bg-gray-900 flex-shrink-0">
                                    {/* Mobile Bookmark Tab shows Title, PC/Search Tab shows Form */}
                                    {(activeTab === 'bookmark' || searchFilter === 'bookmarks') ? (
                                        <div className="flex justify-between items-center h-8">
                                            <div className="font-bold text-orange-400 flex items-center gap-2"><Icons.Bookmark size={18} fill="currentColor"/> ブックマーク</div>
                                            <button onClick={() => loadBookmarks("reload")}><Icons.Refresh size={16}/></button>
                                        </div>
                                    ) : (
                                        <form onSubmit={e => {e.preventDefault(); executeSearch("reload");}} className="flex gap-2">
                                            <input type="text" placeholder="キーワード" className="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-white outline-none focus:border-gray-500" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                                            <button type="submit" className="px-4 font-bold text-black rounded text-sm transition opacity-90 hover:opacity-100" style={{backgroundColor: themeColor}} disabled={isLoadingSearch}>{isLoadingSearch ? "..." : "GO"}</button>
                                        </form>
                                    )}
                                    
                                    {/* Tabs (Hidden on Mobile Bookmark Tab) */}
                                    {activeTab !== 'bookmark' && (
                                        <div className="flex px-2 pt-2">
                                            <button onClick={() => setSearchFilter("all")} className={`filter-tab ${searchFilter === 'all' ? 'active' : ''}`}>全てのノート</button>
                                            <button onClick={() => setSearchFilter("media")} className={`filter-tab ${searchFilter === 'media' ? 'active' : ''}`}>メディア付き</button>
                                            <button onClick={() => setSearchFilter("bookmarks")} className={`filter-tab ${searchFilter === 'bookmarks' ? 'active' : ''}`}>ブックマーク</button>
                                        </div>
                                    )}
                                </div>

                                {/* List Content */}
                                <div className="flex-1 overflow-y-auto mobile-safe-bottom">
                                    {(activeTab === 'bookmark' || searchFilter === 'bookmarks') ? (
                                        // Bookmark List
                                        <>
                                            {bookmarkNotes.length === 0 && !isLoadingBookmarks && <div className="p-8 text-center text-gray-600 text-xs">ブックマークはありません</div>}
                                            {bookmarkNotes.map(n => <Note key={n.id} note={n} onClickUser={u => {setSelectedUser(u); setActiveTab('user');}} onAction={handleAction} onViewImage={(imgs, i) => setViewerState({images: imgs, index: i})} themeColor={themeColor} myUser={myUser}/>)}
                                            <LoadMoreButton onClick={() => loadBookmarks("more")} isLoading={isLoadingBookmarks} />
                                        </>
                                    ) : (
                                        // Search Result List
                                        <>
                                            {searchResults.length === 0 && !isLoadingSearch && <div className="p-8 text-center text-gray-600 text-xs">結果なし</div>}
                                            {searchResults.map(n => <Note key={n.id} note={n} onClickUser={u => {setSelectedUser(u); setActiveTab('user');}} onAction={handleAction} onViewImage={(imgs, i) => setViewerState({images: imgs, index: i})} themeColor={themeColor} myUser={myUser}/>)}
                                            {searchResults.length > 0 && <LoadMoreButton onClick={() => executeSearch("more")} isLoading={isLoadingSearch} />}
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Navigation */}
                        <div className="md:hidden fixed bottom-0 left-0 right-0 h-[60px] bg-gray-900 border-t border-gray-800 flex items-center justify-around pb-safe z-40">
                            <button onClick={() => setActiveTab('timeline')} className={`flex flex-col items-center p-2 ${activeTab === 'timeline' ? 'text-white' : 'text-gray-500'}`}><Icons.Home size={20}/><span className="text-[10px]">TL</span></button>
                            <button onClick={() => setActiveTab('user')} className={`flex flex-col items-center p-2 ${activeTab === 'user' ? 'text-white' : 'text-gray-500'}`}><Icons.User size={20}/><span className="text-[10px]">User</span></button>
                            <button onClick={() => setActiveTab('search')} className={`flex flex-col items-center p-2 ${activeTab === 'search' ? 'text-white' : 'text-gray-500'}`}><Icons.Search size={20}/><span className="text-[10px]">Search</span></button>
                            <button onClick={() => setActiveTab('bookmark')} className={`flex flex-col items-center p-2 ${activeTab === 'bookmark' ? 'text-white' : 'text-gray-500'}`}><Icons.Bookmark size={20}/><span className="text-[10px]">Bookmark</span></button>
                            <button onClick={() => setShowSettings(true)} className="flex flex-col items-center p-2 text-gray-500"><Icons.Settings size={20}/><span className="text-[10px]">Set</span></button>
                        </div>
                        
                        <div className="md:hidden fixed bottom-[70px] right-4 z-40">
                            <button onClick={() => setShowMobilePost(true)} className="w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-black animate-fade-in" style={{backgroundColor: themeColor}}><Icons.Plus size={28} /></button>
                        </div>

                        {showMobilePost && <div className="fixed inset-0 z-50 bg-black md:hidden flex flex-col animate-fade-in"><PostForm token={token} themeColor={themeColor} replyTo={replyTarget} onCancelReply={() => setReplyTarget(null)} onSuccess={() => {setReplyTarget(null); loadTimeline("reload");}} onClose={() => setShowMobilePost(false)} isMobile={true} /></div>}
                        
                        {showSettings && (
                            <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                                <div className="bg-gray-900 border border-gray-700 p-6 rounded-lg w-full max-w-md shadow-2xl">
                                    <h2 className="text-xl font-bold text-white mb-4">Settings</h2>
                                    <div className="space-y-4 mb-6">
                                        <div><label className="text-xs font-bold text-gray-400 block mb-1">API TOKEN</label><input type="password" value={token} onChange={e => setToken(e.target.value)} className="w-full bg-black border border-gray-700 p-2 rounded text-white"/></div>
                                        <div><label className="text-xs font-bold text-gray-400 block mb-1">THEME COLOR</label><div className="flex gap-2"><input type="color" value={themeColor} onChange={e => setThemeColor(e.target.value)} className="h-8 w-16 bg-transparent p-0 border-0"/><input type="text" value={themeColor} onChange={e => setThemeColor(e.target.value)} className="flex-1 bg-black border border-gray-700 p-2 rounded text-white uppercase"/></div></div>
                                    </div>
                                    <div className="flex justify-end gap-2">
                                        <button onClick={() => setShowSettings(false)} className="px-4 py-2 text-gray-400">Cancel</button>
                                        <button onClick={() => { localStorage.setItem("misskey_token", token); localStorage.setItem("misskey_color", themeColor); setShowSettings(false); window.location.reload(); }} className="px-6 py-2 rounded font-bold text-black" style={{backgroundColor: themeColor}}>Save & Reload</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
